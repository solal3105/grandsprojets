<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion ‚Äì Grands Projets</title>
  <link rel="icon" type="image/png" href="/img/logomin.png" sizes="32x32">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Reset & Base */
    * { box-sizing: border-box; }
    body, html { 
      height: 100%; 
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    /* Theme Variables */
    :root {
      --bg-page: var(--gray-50);
      --bg-card: var(--white);
      --text-primary: var(--gray-900);
      --text-secondary: var(--gray-500);
      --text-muted: var(--gray-400);
      --accent: var(--info);
      --accent-hover: var(--info-hover);
      --border: var(--gray-200);
      --info-bg: var(--info-lighter);
      --info-text: var(--info-active);
      --input-bg: var(--gray-100);
      --shadow: 0 4px 20px var(--black-alpha-08);
      --shadow-hover: 0 6px 24px var(--black-alpha-12);
    }

    [data-theme="dark"] {
      --bg-page: var(--black);
      --bg-card: var(--gray-900);
      --text-primary: var(--white);
      --text-secondary: var(--gray-400);
      --text-muted: var(--gray-500);
      --accent: var(--info-light);
      --accent-hover: var(--info-light);
      --border: var(--gray-800);
      --info-bg: var(--info-alpha-20);
      --info-text: var(--info-light);
      --input-bg: var(--gray-900);
      --shadow: 0 4px 20px var(--black-alpha-40);
      --shadow-hover: 0 6px 24px var(--black-alpha-50);
    }

    body {
      background: var(--bg-page);
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* Layout */
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      gap: 24px;
    }

    /* Logo Header */
    .login-logo {
      text-align: center;
      margin-bottom: 16px;
    }

    .login-logo img {
      height: 40px;
      margin-bottom: 8px;
    }

    .login-logo h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }

    /* Main Card */
    .login-card {
      width: 100%;
      max-width: 480px;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 32px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 24px 0;
      text-align: center;
      color: var(--text-primary);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      font-size: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--info-alpha-1);
    }

    [data-theme="dark"] .form-input:focus {
      box-shadow: 0 0 0 3px var(--info-alpha-18);
    }

    /* Buttons */
    .btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 20px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-hover);
    }

    .btn-github {
      background: var(--gray-800);
      color: white;
      border: 1px solid var(--gray-900);
    }

    .btn-github:hover:not(:disabled) {
      background: var(--gray-700);
      transform: translateY(-1px);
    }

    [data-theme="dark"] .btn-github {
      background: var(--black);
      border: 1px solid var(--gray-700);
    }

    [data-theme="dark"] .btn-github:hover:not(:disabled) {
      background: var(--gray-900);
    }

    /* Separator */
    .separator {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 13px;
    }

    .separator::before,
    .separator::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--border);
    }

    .separator span {
      padding: 0 12px;
    }

    /* Info Box */
    .info-box {
      background: var(--info-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .info-box-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: var(--info-text);
    }

    .info-box-text {
      font-size: 14px;
      line-height: 1.6;
      margin: 0;
      color: var(--text-secondary);
    }

    /* Status Message */
    .status {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: var(--primary-lighter);
      color: var(--primary);
      border: 1px solid var(--primary-light);
    }

    .status.error {
      background: var(--danger-lighter);
      color: var(--danger);
      border: 1px solid var(--danger-light);
    }

    [data-theme="dark"] .status.success {
      background: var(--primary-active);
      color: var(--primary-light);
      border: 1px solid var(--primary);
    }

    [data-theme="dark"] .status.error {
      background: var(--danger-hover);
      color: var(--danger-light);
      border: 1px solid var(--danger);
    }

    /* Back Link */
    .back-link {
      text-align: center;
    }

    .back-link a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s ease;
    }

    .back-link a:hover {
      color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 640px) {
      .login-card {
        padding: 24px;
      }

      .login-logo h1 {
        font-size: 24px;
      }

      .card-title {
        font-size: 16px;
      }
    }
  </style>
  <script>
    (function() {
      try {
        var theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
      } catch (e) {}
    })();
  </script>
</head>
<body>
  <div class="login-wrapper">
    <!-- Logo -->
    <div class="login-logo">
      <a href="/" aria-label="Accueil">
        <img src="/img/logo.svg" alt="Grands Projets" />
      </a>
      <h1>Grands Projets</h1>
    </div>

    <!-- Main Login Card -->
    <div class="login-card" role="region" aria-labelledby="card-title">
      <h2 id="card-title" class="card-title">Connectez-vous √† votre compte</h2>

      <div id="auth-area">
        <!-- Email Login Form -->
        <form id="email-form">
          <div class="form-group">
            <label for="email-input" class="form-label">üìß Adresse email</label>
            <input 
              id="email-input" 
              type="email" 
              inputmode="email" 
              autocomplete="email" 
              placeholder="votre.email@exemple.com" 
              aria-label="Email"
              class="form-input"
              required
            />
          </div>

          <button id="magic-btn" class="btn btn-primary" type="submit">
            <i class="fa-regular fa-paper-plane"></i>
            <span>Recevoir un lien de connexion par email</span>
          </button>
        </form>

        <!-- Status Message -->
        <div id="status" class="status" role="alert" aria-live="polite"></div>

        <!-- Separator -->
        <div class="separator" aria-hidden="true">
          <span>ou</span>
        </div>

        <!-- GitHub Login -->
        <button id="github-btn" class="btn btn-github" type="button">
          <i class="fab fa-github"></i>
          <span>Se connecter avec GitHub</span>
        </button>
      </div>
    </div>

    <!-- Info Box -->
    <div class="login-card info-box">
      <h3 class="info-box-title">
        <i class="fa-solid fa-circle-info"></i>
        Pas encore de compte ?
      </h3>
      <p class="info-box-text">
        Seuls les membres invit√©s peuvent acc√©der √† cette plateforme. 
        Contactez l'administrateur de votre organisation pour obtenir une invitation.
      </p>
    </div>

    <!-- Back Link -->
    <div class="back-link">
      <a href="/" aria-label="Retour √† l'accueil">
        <i class="fa-solid fa-arrow-left"></i> Retour √† l'accueil
      </a>
    </div>
  </div>

  <!-- Supabase client via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/modules/auth.js"></script>
  <script>
    const auth = window.AuthModule;
    const statusEl = document.getElementById('status');
    const githubBtn = document.getElementById('github-btn');
    const emailInput = document.getElementById('email-input');
    const magicBtn = document.getElementById('magic-btn');
    const emailForm = document.getElementById('email-form');

    function setStatus(msg, type = '') {
      statusEl.textContent = msg || '';
      statusEl.className = 'status';
      if (msg) {
        statusEl.classList.add('show');
        if (type) statusEl.classList.add(type);
      }
    }

    async function initAuthUI() {
      try {
        const { data: { session } } = await auth.getSession();
        if (session?.user) {
          setStatus(`‚úÖ Connect√© en tant que ${session.user.user_metadata?.user_name || session.user.email || 'utilisateur'}.`, 'success');
          githubBtn.style.display = 'none';
          emailForm.style.display = 'none';
        }
      } catch (e) {
        console.error(e);
      }
    }

    githubBtn.addEventListener('click', async () => {
      try {
        setStatus('üîÑ Redirection vers GitHub‚Ä¶');
        githubBtn.disabled = true;
        const redirectUrl = window.location.origin + '/';
        const { error } = await auth.signInWithGitHub(redirectUrl);
        if (error) {
          console.error('OAuth error:', error);
          setStatus("‚ùå Impossible de d√©marrer l'authentification GitHub.", 'error');
          githubBtn.disabled = false;
        }
      } catch (e) {
        console.error(e);
        setStatus('‚ùå Erreur inattendue.', 'error');
        githubBtn.disabled = false;
      }
    });

    function isValidEmail(v){
      return typeof v === 'string' && /.+@.+\..+/.test(v);
    }

    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const email = (emailInput?.value || '').trim();
        if (!isValidEmail(email)) {
          setStatus('‚ö†Ô∏è Veuillez saisir un email valide.', 'error');
          emailInput?.focus();
          return;
        }
        
        setStatus('üì§ Envoi du lien de connexion‚Ä¶');
        magicBtn.disabled = true;
        githubBtn.disabled = true;
        
        const redirectUrl = window.location.origin + '/login/';
        let error = null;
        
        if (typeof auth.signInWithMagicLink === 'function') {
          ({ error } = await auth.signInWithMagicLink(email, redirectUrl));
        } else {
          const client = auth.getClient && auth.getClient();
          if (client && client.auth && typeof client.auth.signInWithOtp === 'function') {
            ({ error } = await client.auth.signInWithOtp({ 
              email, 
              options: { 
                emailRedirectTo: redirectUrl,
                shouldCreateUser: false
              } 
            }));
          } else {
            error = new Error('M√©thode de magic link indisponible.');
          }
        }
        
        if (error) {
          console.error('Magic link error:', error);
          if (error.message && (error.message.includes('User not found') || error.message.includes('not found') || error.message.includes('Signups not allowed'))) {
            setStatus("‚ùå Cet email n'est pas enregistr√©. Contactez l'administrateur de votre organisation pour obtenir un acc√®s.", 'error');
          } else {
            setStatus("‚ùå √âchec de l'envoi du lien. R√©essayez plus tard.", 'error');
          }
        } else {
          setStatus('‚úÖ Email envoy√© ! V√©rifiez votre bo√Æte de r√©ception.', 'success');
        }
      } catch (e) {
        console.error(e);
        setStatus('‚ùå Erreur inattendue.', 'error');
      } finally {
        setTimeout(() => {
          magicBtn.disabled = false;
          githubBtn.disabled = false;
        }, 2000);
      }
    });

    // Handle redirects back to /login with a hash (GitHub or Magic Link)
    auth.onAuthStateChange((_event, _session) => {
      if (_session?.user) {
        window.location.replace('/');
      }
    });

    // Display human-friendly error if Supabase returns an error hash
    (function handleHashError(){
      try {
        const h = window.location.hash || '';
        if (!h) return;
        const params = new URLSearchParams(h.replace(/^#/, ''));
        const err = params.get('error');
        const code = params.get('error_code');
        if (err) {
          if (code === 'otp_expired') {
            setStatus("‚ö†Ô∏è Le lien a expir√©. Veuillez redemander un nouveau lien.", 'error');
          } else {
            setStatus('‚ùå Erreur de connexion: ' + (code || err), 'error');
          }
        }
      } catch(_) {}
    })();

    initAuthUI();
  </script>
</body>
</html>
