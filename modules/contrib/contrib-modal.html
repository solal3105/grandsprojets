<!-- Contribution modal template -->
<div id="contrib-overlay" class="gp-modal-overlay gp-modal--glass" role="dialog" aria-modal="true" aria-labelledby="contrib-title" aria-hidden="true" style="display:none">
  <div class="gp-modal" role="document">
    <header class="gp-modal-header">
      <button id="contrib-back" class="gp-modal-back" style="display:none;">
        <i class="fa fa-arrow-left" aria-hidden="true"></i>
        <span>Retour</span>
      </button>
      <h1 class="gp-modal-title" id="contrib-title">Proposer une contribution</h1>
      <div class="gp-modal-header-actions" id="contrib-header-actions"></div>
      <button class="gp-modal-close" id="contrib-close" aria-label="Fermer">&times;</button>
    </header>
    <div class="gp-modal-body">
      <!-- Landing: choix initial (affich√© au premier lancement) -->
      <section id="contrib-landing" class="contrib-landing" role="region" aria-label="Choisir une action" hidden>
        <!-- User Info Card -->
        <div id="user-info-card" class="user-info-card" style="display:none;">
          <div class="user-info-card__avatar">
            <i class="fa-solid fa-user"></i>
          </div>
          <div class="user-info-card__content">
            <div class="user-info-card__header">
              <span class="user-info-card__label">Connect√© en tant que</span>
              <div id="user-info-email" class="user-info-card__email"></div>
            </div>
            <div class="user-info-card__meta">
              <span id="user-role-badge" class="user-info-card__badge"></span>
              <span id="user-cities-badge" class="user-info-card__cities"></span>
            </div>
          </div>
          <button id="user-logout-btn" class="user-info-card__logout" title="Se d√©connecter">
            <i class="fa-solid fa-right-from-bracket"></i>
          </button>
        </div>
        
        <!-- S√©lecteur de ville -->
        <div class="landing-city-selector" id="landing-city-selector-container">
          <label for="landing-city-select" class="landing-city-label">
            <i class="fa-solid fa-location-dot"></i>
            S√©lectionnez votre collectivit√©
          </label>
          <select id="landing-city-select" class="landing-city-select" required>
            <option value="">-- Choisissez une ville --</option>
            <!-- Options peupl√©es dynamiquement -->
          </select>
          <p class="landing-city-help">Cette ville sera utilis√©e pour toutes vos contributions</p>
        </div>
        
        <h3 class="landing-title" id="landing-actions-title" style="display:none;">Que voulez-vous faire&nbsp;?</h3>
        <div class="landing-cards" id="landing-cards" role="list" style="display:none;">
          <button class="choice-card" role="listitem" id="landing-create" data-target="create" aria-describedby="landing-create-desc">
            <span class="card-icon" aria-hidden="true"><i class="fa-solid fa-plus-circle"></i></span>
            <span class="card-title">Cr√©er une contribution</span>
            <span class="card-desc" id="landing-create-desc">Ajoutez un nouveau projet avec son trac√© et ses informations.</span>
          </button>
          <button class="choice-card" role="listitem" id="landing-edit" data-target="list" aria-describedby="landing-edit-desc">
            <span class="card-icon" aria-hidden="true"><i class="fa-solid fa-pen-to-square"></i></span>
            <span class="card-title">Modifier mes contributions</span>
            <span class="card-desc" id="landing-edit-desc">Consultez et mettez √† jour vos contributions existantes.</span>
          </button>
          <button class="choice-card" role="listitem" id="landing-categories" data-target="categories" aria-describedby="landing-categories-desc">
            <span class="card-icon" aria-hidden="true"><i class="fa-solid fa-tags"></i></span>
            <span class="card-title">G√©rer les cat√©gories</span>
            <span class="card-desc" id="landing-categories-desc">Cr√©ez ou modifiez les cat√©gories et leurs ic√¥nes.</span>
          </button>
          <button class="choice-card" role="listitem" id="landing-users" data-target="users" aria-describedby="landing-users-desc">
            <span class="card-icon" aria-hidden="true"><i class="fa-solid fa-users"></i></span>
            <span class="card-title">G√©rer les utilisateurs</span>
            <span class="card-desc" id="landing-users-desc">Visualisez et modifiez les r√¥les des utilisateurs.</span>
          </button>
          <button class="choice-card" role="listitem" id="landing-cities" data-target="cities" aria-describedby="landing-cities-desc">
            <span class="card-icon" aria-hidden="true"><i class="fa-solid fa-city"></i></span>
            <span class="card-title">G√©rer les villes</span>
            <span class="card-desc" id="landing-cities-desc">Ajoutez ou modifiez les villes disponibles.</span>
          </button>
        </div>
      </section>
      <!-- Bouton Retour vers la page d'accueil de la modale -->
      <div class="contrib-toolbar" aria-hidden="false">
      </div>

      

      <!-- Panel: Cr√©ation / √âdition -->
      <section id="contrib-panel-create" role="tabpanel" aria-label="Cr√©er">
      <!-- Stepper navigation -->
      <div class="contrib-stepper" id="contrib-stepper" role="tablist" aria-label="√âtapes de contribution">
        <button class="contrib-step" id="contrib-step-1-tab" role="tab" aria-selected="true" tabindex="0">1. Infos</button>
        <button class="contrib-step" id="contrib-step-2-tab" role="tab" aria-selected="false" tabindex="-1">2. Trac√©</button>
        <button class="contrib-step" id="contrib-step-3-tab" role="tab" aria-selected="false" tabindex="-1">3. Options</button>
        <button class="contrib-step" id="contrib-step-4-tab" role="tab" aria-selected="false" tabindex="-1">4. Liens</button>
      </div>
      <!-- Assistant r√©dacteur (Carte verte anim√©e, √©tape 3 uniquement) -->
      <div id="assistant-writer-card" class="contrib-step-3" role="region" aria-label="Assistant r√©dacteur"
           style="margin:12px 0 14px; border:1px solid var(--primary); border-radius:14px; padding:14px; background:linear-gradient(180deg,var(--primary-lighter),var(--primary-lighter)); box-shadow:0 2px 8px var(--primary-alpha-1); position:relative; overflow:hidden;">
        <!-- overlay cliquable sur toute la carte -->
        <a href="/assistant-ia/" target="_blank" rel="noopener" aria-label="Ouvrir l'assistant IA"
           style="position:absolute; inset:0; z-index:1; opacity:0;">
        </a>
        <div style="display:flex; gap:12px; align-items:center; position:relative; z-index:2;">
          <div class="sparkle" aria-hidden="true" style="font-size:28px; line-height:1;">‚ú®</div>
          <div style="flex:1 1 auto; min-width:0;">
            <h3 class="title" style="margin:0; color:var(--primary-active); font-size:18px;">
              <span class="shimmer">R√©diger avec l'assistant</span>
            </h3>
            <div class="subtitle" style="margin:2px 0 8px; color:var(--primary-active); font-size:14px;">Premier jet en 1 minute</div>
            <div class="chips" aria-label="L'assistant vous aide pour">
              <span>Markdown</span>
              <span>M√©ta</span>
              <span>Description</span>
            </div>
          </div>
          <a id="contrib-assistant-link" href="/assistant-ia/" target="_blank" rel="noopener"
             style="display:inline-block; background:var(--primary); color:var(--white); padding:10px 14px; border-radius:10px; text-decoration:none; font-weight:600; white-space:nowrap; position:relative; z-index:3;">
            Ouvrir
          </a>
        </div>
      </div>
      <!-- Styles sp√©cifiques √† la carte assistant (scop√©s) -->
      <style>
        /* Pop-in √† l'apparition en √©tape 3 */
        #assistant-writer-card { animation: agp-pop 480ms cubic-bezier(.2,.8,.2,1) both; }
        @keyframes agp-pop { from { transform: translateY(-6px) scale(.98); opacity:.0; } to { transform: translateY(0) scale(1); opacity:1; } }

        /* Halo pulsant vert (accent non intrusif) */
        #assistant-writer-card::after {
          content:""; position:absolute; inset:-2px; border-radius:16px;
          border:2px solid var(--primary-alpha-35); pointer-events:none; filter:blur(.3px);
          animation: agp-pulse 1600ms ease-out infinite;
        }
        @keyframes agp-pulse { 0% { opacity:.55; } 60% { opacity:.15; } 100% { opacity:.35; } }

        /* L'emoji flotte l√©g√®rement */
        #assistant-writer-card .sparkle { animation: agp-float 2800ms ease-in-out infinite; }
        @keyframes agp-float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

        /* Titre scintillant discret */
        #assistant-writer-card .shimmer {
          background: linear-gradient(90deg, var(--primary-active) 0%, var(--primary-light) 50%, var(--primary-active) 100%);
          -webkit-background-clip: text; background-clip: text; color: transparent;
          background-size: 200% 100%; animation: agp-shimmer 2200ms linear infinite;
        }
        @keyframes agp-shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Petites pastilles explicatives */
        #assistant-writer-card .chips { display:flex; gap:6px; flex-wrap:wrap; }
        #assistant-writer-card .chips span {
          background:var(--primary-lighter); color:var(--primary-active); border:1px solid var(--primary-lighter);
          border-radius:999px; padding:4px 8px; font-size:12px; line-height:1;
          animation: agp-chip-in 420ms cubic-bezier(.2,.8,.2,1) both;
        }
        #assistant-writer-card .chips span:nth-child(2) { animation-delay: 60ms; }
        #assistant-writer-card .chips span:nth-child(3) { animation-delay: 120ms; }
        @keyframes agp-chip-in { from { transform: translateY(4px); opacity:0; } to { transform: translateY(0); opacity:1; } }
      </style>

      <form id="contrib-form" class="contrib-form">
        <div class="form-row contrib-step-1">
          <label for="contrib-project-name">Nom du projet</label>
          <input type="text" id="contrib-project-name" name="project_name" required placeholder="Ex: Tram T10 ‚Äì Phase 2" />
        </div>

        <!-- Champ ville cach√© - Pr√©-rempli depuis le landing -->
        <input type="hidden" id="contrib-city" name="ville" />

        <div class="form-row contrib-step-1">
          <label for="contrib-category">Cat√©gorie</label>
          <select id="contrib-category" name="category_layer" required disabled>
            <option value="">S√©lectionnez d'abord une collectivit√©</option>
          </select>
          <small id="contrib-category-help" style="display:none; margin-top:4px; color:var(--warning);">
            <i class="fa-solid fa-exclamation-triangle"></i> Aucune cat√©gorie disponible. 
            <a href="#" id="contrib-create-category-link" style="color:var(--info); text-decoration:underline;">Cr√©er une cat√©gorie</a>
          </small>
        </div>

        <div class="contrib-step-2" id="contrib-geom-mode">
          <!-- Radios cach√©s pour l'accessibilit√© et la soumission -->
          <div class="visually-hidden" aria-hidden="true">
            <input type="radio" id="geom-mode-file" name="contrib-geom-mode" value="file" checked>
            <input type="radio" id="geom-mode-draw" name="contrib-geom-mode" value="draw">
          </div>
          <div class="geom-mode-cards" role="list">
            <button type="button" class="geom-card is-active" id="geom-card-file" role="listitem" aria-pressed="true" aria-controls="contrib-file-row" data-mode="file">
              <span class="geom-icon" aria-hidden="true"><i class="fa-solid fa-file-arrow-up"></i></span>
              <span class="geom-title">Importer un fichier GeoJSON</span>
              <span class="geom-desc">D√©posez votre trac√© au format GeoJSON (.geojson, .json)</span>
            </button>
            <button type="button" class="geom-card" id="geom-card-draw" role="listitem" aria-pressed="false" aria-controls="contrib-draw-panel" data-mode="draw">
              <span class="geom-icon" aria-hidden="true"><i class="fa-solid fa-pen-ruler"></i></span>
              <span class="geom-title">Dessiner sur la carte</span>
              <span class="geom-desc">Tracez votre itin√©raire ou zone directement sur la carte</span>
            </button>
          </div>
        </div>

        <div class="form-row contrib-step-2" id="contrib-file-row">
          <input type="file" id="contrib-geojson" name="geojson_file" accept=".geojson,application/geo+json,application/json" required style="display:none;" />
          <div id="contrib-dropzone" class="file-dropzone" role="button" tabindex="0" aria-label="D√©poser un fichier GeoJSON ou cliquer pour choisir">
            <div class="dz-text">
              <div class="dz-title">D√©posez votre fichier GeoJSON</div>
              <div class="dz-sub">‚Ä¶ ou cliquez pour choisir un fichier</div>
            </div>
            <div class="dz-selected">
              <span class="dz-icon" aria-hidden="true"><i class="fa-regular fa-file-lines"></i></span>
              <span id="contrib-dz-filename" class="dz-filename"></span>
            </div>
          </div>
          
        </div>

        <div class="form-row contrib-step-2" id="contrib-draw-panel" style="display:none;">
          <div id="contrib-draw-map" style="height:320px; border-radius:8px; overflow:hidden;"></div>
        </div>

        <div class="form-row contrib-step-3">
          <label for="contrib-cover">Cover (optionnelle)</label>
          <input type="file" id="contrib-cover" name="cover_file" accept="image/png,image/jpeg,image/webp" />
          <small>Image .png, .jpg ou .webp. Elle sera stock√©e et son URL journalis√©e.</small>
          <div id="contrib-cover-preview" style="margin-top:6px"></div>
        </div>

        <div class="form-row contrib-step-3">
          <label for="contrib-meta">Meta</label>
          <textarea id="contrib-meta" name="meta" rows="3" maxlength="200" placeholder="M√©ta information (ex: tag, note, source)" required></textarea>
          <small>Texte utilis√© pour le SEO (extrait dans les r√©sultats Google). Visez une phrase claire et percutante (~160 caract√®res).</small>
        </div>

        <div class="form-row contrib-step-3">
          <label for="contrib-description">Description</label>
          <textarea id="contrib-description" name="description" rows="3" placeholder="Courte description du projet (ex: 1-3 phrases)" required></textarea>
          <small>Donnez l'essentiel du projet en 2‚Äì3 phrases, de fa√ßon engageante pour donner envie d'en savoir plus.</small>
        </div>

        <div class="form-row contrib-step-3">
          <label for="contrib-markdown">Contenu Markdown (optionnel)</label>
          <textarea id="contrib-markdown" name="markdown" rows="8" placeholder="# Titre\n\nD√©crivez le projet, ajoutez des liens, etc."></textarea>
          <small>
            R√©digez le contenu de l'article en <strong>Markdown</strong> (titres, images, liens, tableaux‚Ä¶).
            Astuce&nbsp;: utilisez un √©diteur d√©di√© comme
            <a href="https://dillinger.io/" target="_blank" rel="noopener">Dillinger</a>
            ou <a href="https://stackedit.io/app" target="_blank" rel="noopener">StackEdit</a> pour vous aider.
            Le contenu sera stock√© en Markdown et li√© √† votre contribution.
          </small>
        </div>

        <div class="form-row contrib-step-4 official-link-card">
          <label for="contrib-official-url">üîó Lien officiel du projet (optionnel)</label>
          <input type="url" id="contrib-official-url" name="official_url" placeholder="https://..." />
          <small>Un unique lien officiel vers la page du projet (quelle que soit la cat√©gorie).</small>
        </div>

        <div class="contrib-step-4" id="contrib-docs">
          <div class="contrib-docs-title">üìÑ Documents li√©s</div>
          <div id="contrib-existing-docs" class="contrib-existing-docs" aria-live="polite" style="margin-bottom:8px;"></div>
        </div>

        <!-- Legacy form actions - Supprim√©, maintenant dans footer -->
        <!-- Boutons d'√©dition sp√©ciaux - restent dans le form car contextuels -->
        <div class="form-actions" style="margin-top:12px; display:none; gap:8px; align-items:center;">
          <button type="button" id="contrib-cancel-edit" class="gp-btn gp-btn--secondary" style="display:none">
            <span>Annuler la modification</span>
          </button>
          <button type="button" id="contrib-delete" class="gp-btn gp-btn--secondary" title="Supprimer la contribution"
                  style="display:none; color:var(--white); background:var(--danger); border-color:var(--danger-hover);">
            <i class="fa fa-trash" aria-hidden="true"></i>
            <span>Supprimer</span>
          </button>
        </div>
      </form>
      </section>

      <!-- Panel: Liste des contributions -->
      <section id="contrib-panel-list" role="tabpanel" aria-labelledby="contrib-tab-list" hidden>
        <!-- Toolbar de filtres -->
        <div class="list-toolbar">
          <div class="list-toolbar__primary">
            <!-- Recherche -->
            <div class="search-input-wrapper">
              <i class="fa-solid fa-search search-input-icon"></i>
              <input 
                type="text" 
                id="contrib-search" 
                class="search-input"
                placeholder="Rechercher un projet..." 
                autocomplete="off"
              />
            </div>

            <!-- Filtres secondaires -->
            <div class="list-toolbar__filters">
              <div class="filter-group">
                <select id="contrib-filter-category" class="filter-select" aria-label="Filtrer par cat√©gorie">
                  <option value="">Toutes les cat√©gories</option>
                </select>
              </div>

              <div class="filter-group">
                <select id="contrib-sort" class="filter-select" aria-label="Trier par">
                  <option value="updated_at:desc">Plus r√©centes</option>
                  <option value="updated_at:asc">Plus anciennes</option>
                  <option value="project_name:asc">Nom A‚ÜíZ</option>
                  <option value="project_name:desc">Nom Z‚ÜíA</option>
                </select>
              </div>

              <label class="filter-toggle">
                <input type="checkbox" id="contrib-mine-only" />
                <span class="filter-toggle-label">
                  <i class="fa-solid fa-user"></i>
                  Mes contributions uniquement
                </span>
              </label>
            </div>
          </div>
        </div>

        <!-- Liste des contributions -->
        <div class="list-container">
          <div id="contrib-list" class="contrib-list" role="list">
            <!-- Items inject√©s en JS -->
            <div id="contrib-list-sentinel" style="height:1px;"></div>
          </div>
        </div>
      </section>

      <!-- Panel: Gestion des cat√©gories -->
      <section id="contrib-panel-categories" role="tabpanel" aria-label="G√©rer les cat√©gories" hidden>
        <div id="categories-content" style="display:none; transition:opacity 0.2s ease-in;">
          <div id="categories-list" class="categories-list"></div>
        </div>
        
        <!-- Formulaire de cat√©gorie d√©plac√© dans contrib-category-modal.html -->
      </section>

      <!-- Panel: G√©rer les utilisateurs -->
      <section id="contrib-panel-users" class="contrib-panel" hidden>
        <div class="panel-toolbar" style="margin:16px 0;">
          <div class="search-box" style="position:relative;flex:1;">
            <i class="fa-solid fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--gray-400);"></i>
            <input 
              type="search" 
              id="users-search" 
              placeholder="Rechercher par email..."
              autocomplete="off"
              style="width:100%;padding:10px 12px 10px 40px;border:1px solid var(--gray-300);border-radius:8px;font-size:14px;"
            />
          </div>
        </div>
        
        <div id="users-status" class="panel-status" role="status" aria-live="polite" style="margin:12px 0;color:var(--gray-500);font-size:14px;"></div>
        
        <div id="users-list" class="users-list" style="max-height:500px;overflow-y:auto;padding-right:8px;"></div>
      </section>

      <!-- Panel: G√©rer les villes -->
      <section id="contrib-panel-cities" class="contrib-panel" hidden>
        
        <div id="cities-status" class="panel-status" role="status" aria-live="polite" style="margin:12px 0;color:var(--gray-500);font-size:14px;"></div>
        
        <div id="cities-list" class="cities-list" style="max-height:500px;overflow-y:auto;padding-right:8px;"></div>
      </section>
    </div>
    
    <footer class="gp-modal-footer" id="contrib-footer">
      <div class="gp-modal-footer-left">
        <span class="footer-status" id="contrib-status"></span>
      </div>
      <div class="gp-modal-footer-right">
        <button type="button" id="contrib-prev-footer" class="gp-btn gp-btn--secondary">
          <span>Pr√©c√©dent</span>
        </button>
        <button type="button" id="contrib-next-footer" class="gp-btn gp-btn--primary">
          <span>Suivant</span>
        </button>
        <button type="submit" id="contrib-submit-footer" class="gp-btn gp-btn--primary" style="display:none;">
          <i class="fa fa-paper-plane" aria-hidden="true"></i>
          <span>Envoyer</span>
        </button>
      </div>
    </footer>
  </div>
</div>
