<!-- Create Contribution Modal -->
<div id="create-modal-overlay" class="gp-modal-overlay gp-modal--glass" role="dialog" aria-modal="true" aria-labelledby="create-modal-title" aria-hidden="true">
  <div class="gp-modal" role="document">
    <header class="gp-modal-header">
      <h1 class="gp-modal-title" id="create-modal-title">
        <i class="fa-solid fa-plus-circle"></i>
        Cr√©er une contribution
      </h1>
      <button class="gp-modal-close" id="create-modal-close" aria-label="Fermer">&times;</button>
    </header>
    <div class="gp-modal-body">
      <!-- Stepper navigation -->
      <div class="contrib-stepper" id="contrib-stepper" role="tablist" aria-label="√âtapes de contribution">
        <button class="contrib-step" id="contrib-step-1-tab" role="tab" aria-selected="true" tabindex="0">1. Infos</button>
        <button class="contrib-step" id="contrib-step-2-tab" role="tab" aria-selected="false" tabindex="-1">2. Trac√©</button>
        <button class="contrib-step" id="contrib-step-3-tab" role="tab" aria-selected="false" tabindex="-1">3. Options</button>
        <button class="contrib-step" id="contrib-step-4-tab" role="tab" aria-selected="false" tabindex="-1">4. Liens</button>
      </div>
      
      <!-- Assistant r√©dacteur (Carte verte anim√©e, √©tape 3 uniquement) -->
      <div id="assistant-writer-card" class="contrib-step-3" role="region" aria-label="Assistant r√©dacteur"
           style="margin:12px 0 14px; border:1px solid var(--primary); border-radius:14px; padding:14px; background:linear-gradient(180deg,var(--primary-lighter),var(--primary-lighter)); box-shadow:0 2px 8px var(--primary-alpha-1); position:relative; overflow:hidden;">
        <!-- overlay cliquable sur toute la carte -->
        <a href="/assistant-ia/" target="_blank" rel="noopener" aria-label="Ouvrir l'assistant IA"
           style="position:absolute; inset:0; z-index:1; opacity:0;">
        </a>
        <div style="display:flex; gap:12px; align-items:center; position:relative; z-index:2;">
          <div class="sparkle" aria-hidden="true" style="font-size:28px; line-height:1;">‚ú®</div>
          <div style="flex:1 1 auto; min-width:0;">
            <h3 class="title" style="margin:0; color:var(--primary-active); font-size:18px;">
              <span class="shimmer">R√©diger avec l'assistant</span>
            </h3>
            <div class="subtitle" style="margin:2px 0 8px; color:var(--primary-active); font-size:14px;">Premier jet en 1 minute</div>
            <div class="chips" aria-label="L'assistant vous aide pour">
              <span>Markdown</span>
              <span>M√©ta</span>
              <span>Description</span>
            </div>
          </div>
          <a id="contrib-assistant-link" href="/assistant-ia/" target="_blank" rel="noopener"
             style="display:inline-block; background:var(--primary); color:var(--white); padding:10px 14px; border-radius:10px; text-decoration:none; font-weight:600; white-space:nowrap; position:relative; z-index:3;">
            Ouvrir
          </a>
        </div>
      </div>
      
      <!-- Styles sp√©cifiques √† la carte assistant (scop√©s) -->
      <style>
        /* Pop-in √† l'apparition en √©tape 3 */
        #assistant-writer-card { animation: agp-pop 480ms cubic-bezier(.2,.8,.2,1) both; }
        @keyframes agp-pop { from { transform: translateY(-6px) scale(.98); opacity:.0; } to { transform: translateY(0) scale(1); opacity:1; } }

        /* Halo pulsant vert (accent non intrusif) */
        #assistant-writer-card::after {
          content:""; position:absolute; inset:-2px; border-radius:16px;
          border:2px solid var(--primary-alpha-35); pointer-events:none; filter:blur(.3px);
          animation: agp-pulse 1600ms ease-out infinite;
        }
        @keyframes agp-pulse { 0% { opacity:.55; } 60% { opacity:.15; } 100% { opacity:.35; } }

        /* L'emoji flotte l√©g√®rement */
        #assistant-writer-card .sparkle { animation: agp-float 2800ms ease-in-out infinite; }
        @keyframes agp-float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

        /* Titre scintillant discret */
        #assistant-writer-card .shimmer {
          background: linear-gradient(90deg, var(--primary-active) 0%, var(--primary-light) 50%, var(--primary-active) 100%);
          -webkit-background-clip: text; background-clip: text; 
          color: var(--primary-active); /* Fallback color */
          -webkit-text-fill-color: transparent;
          background-size: 200% 100%; animation: agp-shimmer 2200ms linear infinite;
        }
        @keyframes agp-shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Petites pastilles explicatives */
        #assistant-writer-card .chips { display:flex; gap:6px; flex-wrap:wrap; }
        #assistant-writer-card .chips span {
          background:var(--primary-lighter); color:var(--primary-active); border:1px solid var(--primary-lighter);
          border-radius:999px; padding:4px 8px; font-size:12px; line-height:1;
          animation: agp-chip-in 420ms cubic-bezier(.2,.8,.2,1) both;
        }
        #assistant-writer-card .chips span:nth-child(2) { animation-delay: 60ms; }
        #assistant-writer-card .chips span:nth-child(3) { animation-delay: 120ms; }
        @keyframes agp-chip-in { from { transform: translateY(4px); opacity:0; } to { transform: translateY(0); opacity:1; } }
      </style>

      <form id="contrib-form" class="contrib-form">
        <div class="form-row contrib-step-1">
          <label for="contrib-project-name">Nom du projet</label>
          <input type="text" id="contrib-project-name" name="project_name" required placeholder="Ex: Tram T10 ‚Äì Phase 2" />
        </div>

        <!-- Champ ville cach√© - Pr√©-rempli depuis le landing -->
        <input type="hidden" id="contrib-city" name="ville" />

        <div class="form-row contrib-step-1">
          <label for="contrib-category">Cat√©gorie</label>
          <select id="contrib-category" name="category_layer" required disabled>
            <option value="">S√©lectionnez d'abord une collectivit√©</option>
          </select>
          <small id="contrib-category-help" style="display:none; margin-top:4px; color:var(--warning);">
            <i class="fa-solid fa-exclamation-triangle"></i> Aucune cat√©gorie disponible. 
            <a href="#" id="contrib-create-category-link" style="color:var(--info); text-decoration:underline;">Cr√©er une cat√©gorie</a>
          </small>
        </div>

        <div class="contrib-step-2" id="contrib-geom-mode">
          <!-- Radios cach√©s pour l'accessibilit√© et la soumission -->
          <div class="visually-hidden" aria-hidden="true">
            <input type="radio" id="geom-mode-file" name="contrib-geom-mode" value="file" checked>
            <input type="radio" id="geom-mode-draw" name="contrib-geom-mode" value="draw">
          </div>
          <div class="geom-mode-cards" role="list">
            <button type="button" class="geom-card is-active" id="geom-card-file" role="listitem" aria-pressed="true" aria-controls="contrib-file-row" data-mode="file">
              <span class="geom-icon" aria-hidden="true"><i class="fa-solid fa-file-arrow-up"></i></span>
              <span class="geom-title">Importer un fichier GeoJSON</span>
              <span class="geom-desc">D√©posez votre trac√© au format GeoJSON (.geojson, .json)</span>
            </button>
            <button type="button" class="geom-card" id="geom-card-draw" role="listitem" aria-pressed="false" aria-controls="contrib-draw-panel" data-mode="draw">
              <span class="geom-icon" aria-hidden="true"><i class="fa-solid fa-pen-ruler"></i></span>
              <span class="geom-title">Dessiner sur la carte</span>
              <span class="geom-desc">Tracez votre itin√©raire ou zone directement sur la carte</span>
            </button>
          </div>
        </div>

        <div class="form-row contrib-step-2" id="contrib-file-row">
          <input type="file" id="contrib-geojson" name="geojson_file" accept=".geojson,application/geo+json,application/json" required style="display:none;" />
          <div id="contrib-dropzone" class="file-dropzone" role="button" tabindex="0" aria-label="D√©poser un fichier GeoJSON ou cliquer pour choisir">
            <div class="dz-text">
              <div class="dz-title">D√©posez votre fichier GeoJSON</div>
              <div class="dz-sub">‚Ä¶ ou cliquez pour choisir un fichier</div>
            </div>
            <div class="dz-selected">
              <span class="dz-icon" aria-hidden="true"><i class="fa-regular fa-file-lines"></i></span>
              <span id="contrib-dz-filename" class="dz-filename"></span>
            </div>
          </div>
          
        </div>

        <div class="form-row contrib-step-2" id="contrib-draw-panel" style="display:none;">
          <div id="contrib-draw-map" style="height:320px; border-radius:8px; overflow:hidden;"></div>
        </div>

        <div class="form-row contrib-step-3">
          <label for="contrib-cover">Cover (optionnelle)</label>
          <input type="file" id="contrib-cover" name="cover_file" accept="image/png,image/jpeg,image/webp" style="display:none;" />
          <div id="contrib-cover-dropzone" class="file-dropzone cover-dropzone" role="button" tabindex="0" aria-label="D√©poser une image de couverture ou cliquer pour choisir">
            <div class="dz-text">
              <div class="dz-title">D√©posez votre image de couverture</div>
              <div class="dz-sub">‚Ä¶ ou cliquez pour choisir un fichier</div>
            </div>
            <div class="dz-selected">
              <span class="dz-icon"><i class="fa-regular fa-image"></i></span>
              <span class="dz-filename" id="contrib-cover-filename"></span>
            </div>
          </div>
          <small>Image .png, .jpg ou .webp. Elle sera stock√©e et son URL journalis√©e.</small>
          <div id="contrib-cover-preview" style="margin-top:6px"></div>
        </div>

        <div class="form-row contrib-step-3">
          <label for="contrib-meta">Meta</label>
          <textarea id="contrib-meta" name="meta" rows="3" maxlength="200" placeholder="M√©ta information (ex: tag, note, source)" required></textarea>
          <small>Texte utilis√© pour le SEO (extrait dans les r√©sultats Google). Visez une phrase claire et percutante (~160 caract√®res).</small>
        </div>

        <div class="form-row contrib-step-3">
          <label for="contrib-description">Description</label>
          <textarea id="contrib-description" name="description" rows="3" placeholder="Courte description du projet (ex: 1-3 phrases)" required></textarea>
          <small>Donnez l'essentiel du projet en 2‚Äì3 phrases, de fa√ßon engageante pour donner envie d'en savoir plus.</small>
        </div>

        <div class="form-row contrib-step-3">
          <label for="contrib-markdown">Contenu Markdown (optionnel)</label>
          <textarea id="contrib-markdown" name="markdown" rows="8" placeholder="# Titre\n\nD√©crivez le projet, ajoutez des liens, etc."></textarea>
          <small>
            R√©digez le contenu de l'article en <strong>Markdown</strong> (titres, images, liens, tableaux‚Ä¶).
            Astuce&nbsp;: utilisez un √©diteur d√©di√© comme
            <a href="https://dillinger.io/" target="_blank" rel="noopener">Dillinger</a>
            ou <a href="https://stackedit.io/app" target="_blank" rel="noopener">StackEdit</a> pour vous aider.
            Le contenu sera stock√© en Markdown et li√© √† votre contribution.
          </small>
        </div>

        <div class="form-row contrib-step-4 official-link-card">
          <label for="contrib-official-url">üîó Lien officiel du projet (optionnel)</label>
          <input type="url" id="contrib-official-url" name="official_url" placeholder="https://..." />
          <small>Un unique lien officiel vers la page du projet (quelle que soit la cat√©gorie).</small>
        </div>

        <div class="contrib-step-4" id="contrib-docs">
          <div class="contrib-docs-title">üìÑ Documents li√©s</div>
          <div id="contrib-existing-docs" class="contrib-existing-docs" aria-live="polite" style="margin-bottom:8px;"></div>
        </div>
      </form>
    </div>
    <footer class="gp-modal-footer">
      <button type="button" id="contrib-prev" class="gp-btn gp-btn--secondary">
        <i class="fa-solid fa-arrow-left"></i>
        <span>Pr√©c√©dent</span>
      </button>
      <button type="button" id="contrib-next" class="gp-btn gp-btn--primary">
        <span>Suivant</span>
        <i class="fa-solid fa-arrow-right"></i>
      </button>
      <button type="submit" form="contrib-form" id="contrib-submit" class="gp-btn gp-btn--primary" style="display:none;">
        <i class="fa-solid fa-check"></i>
        <span>Enregistrer la contribution</span>
      </button>
    </footer>
  </div>
</div>
