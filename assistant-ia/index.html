<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistant IA ‚Äî Grands Projets</title>
  <meta name="description" content="Assistant IA pour pr√©parer les contenus: Markdown, m√©ta et description √† partir de PDFs, URLs et notes." />
  <link rel="icon" href="/img/logomin.png" />
  
  <!-- Syst√®mes unifi√©s existants -->
  <link rel="stylesheet" href="/styles/00-colors.css" />
  <link rel="stylesheet" href="/styles/13-modal-system.css" />
  <link rel="stylesheet" href="/styles/gp-button-system.css" />
  <link rel="stylesheet" href="/styles/fiche-markdown.css" />
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          colors: {
            // Primary colors (existent dans 00-colors.css)
            primary: 'var(--primary)',
            'primary-hover': 'var(--primary-hover)',
            'primary-active': 'var(--primary-active)',
            'primary-light': 'var(--primary-light)',
            'primary-lighter': 'var(--primary-lighter)',
            
            // Danger colors (existent dans 00-colors.css)
            danger: 'var(--danger)',
            'danger-hover': 'var(--danger-hover)',
            'danger-light': 'var(--danger-light)',
            'danger-lighter': 'var(--danger-lighter)',
            
            // Info colors (existent dans 00-colors.css)
            info: 'var(--info)',
            'info-light': 'var(--info-light)',
            'info-lighter': 'var(--info-lighter)',
          }
        }
      }
    }
  </script>
  
  <!-- PDF.js, Markdown, Modal Helper -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="/modules/modal-helper.js"></script>
  
  <!-- Gestion du th√®me et des villes -->
  <script src="/modules/thememanager.js"></script>
  <script src="/modules/citymanager.js"></script>
  <script src="/modules/citybranding.js"></script>
  
  <!-- Th√®me et logo city branding -->
  <script>
    // Appliquer le th√®me imm√©diatement
    (function() {
      try {
        const savedTheme = localStorage.getItem('theme');
        const theme = savedTheme || (window.matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        // V√©rifier que document.documentElement est disponible
        if (document && document.documentElement) {
          document.documentElement.setAttribute('data-theme', theme);
        }
      } catch (e) {}
    })();
  </script>
</head>

<body class="bg-[var(--surface-base)] text-[var(--text-primary)] min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <a href="/" aria-label="Retour √† l'accueil">
        <img id="logo-img" src="/img/logo.svg" alt="Grands Projets" class="h-14 w-auto" />
      </a>
      <span id="source-count" class="px-3 py-1 bg-[var(--primary-alpha-12)] text-[var(--primary)] rounded-full text-sm font-medium">0 source</span>
    </div>
    
    <!-- Hero -->
    <div class="relative bg-[var(--primary-lighter)] border border-[var(--primary-light)] rounded-2xl p-6 mb-6 shadow-lg overflow-hidden">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-[var(--primary)] text-[var(--text-on-primary)] rounded-xl flex items-center justify-center text-2xl shrink-0">‚ú®</div>
        <div>
          <h1 class="text-2xl font-bold text-[var(--primary)] mb-1">Assistant IA de r√©daction</h1>
          <p class="text-[var(--text-secondary)]">G√©n√©rez automatiquement des contenus optimis√©s √† partir de vos sources</p>
        </div>
      </div>
    </div>
    
    <!-- Stepper -->
    <div class="flex items-center justify-center gap-2 my-8 flex-wrap">
      <div class="flex items-center gap-3">
        <div id="step1-circle" class="w-10 h-10 rounded-full flex items-center justify-center font-semibold border-2 border-[var(--primary)] bg-[var(--primary)] text-[var(--text-on-primary)] transition-all">1</div>
        <div id="step1-label" class="text-sm font-medium text-[var(--primary)]">S√©lection des sources</div>
      </div>
      <div id="divider1" class="w-12 h-0.5 bg-[var(--border-medium)] transition-colors"></div>
      <div class="flex items-center gap-3">
        <div id="step2-circle" class="w-10 h-10 rounded-full flex items-center justify-center font-semibold border-2 border-[var(--border-medium)] bg-[var(--surface-base)] text-[var(--text-tertiary)] transition-all">2</div>
        <div id="step2-label" class="text-sm font-medium text-[var(--text-tertiary)]">R√©sultats g√©n√©r√©s</div>
      </div>
    </div>
    
    <!-- √âtape 1 : Sources -->
    <div id="step1-content" class="transition-opacity duration-300">
      <div class="bg-[var(--card)] border border-[var(--border-light)] rounded-xl p-6 shadow-sm">
        
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 bg-[var(--primary-alpha-12)] text-[var(--primary)] rounded-lg flex items-center justify-center text-xl">üìÅ</div>
          <div>
            <h2 class="text-xl font-bold">Ajoutez vos sources</h2>
            <p class="text-sm text-[var(--text-tertiary)]">PDFs, URLs, notes ou recherchez sur le web</p>
          </div>
        </div>
        
        <!-- PDFs -->
        <div class="mb-6">
          <label class="font-semibold block mb-1">PDFs</label>
          <p class="text-xs text-[var(--text-tertiary)] mb-2">Glissez-d√©posez ou cliquez (max 5, 10 MB chacun)</p>
          <input id="pdf-input" type="file" accept="application/pdf" multiple class="hidden" />
          <div id="pdf-drop" class="border-2 border-dashed border-[var(--primary-light)] bg-[var(--primary-lighter)] rounded-xl p-4 text-center text-[var(--primary)] cursor-pointer hover:bg-[var(--primary-alpha-20)] transition-colors" role="button" tabindex="0">
            üìÑ D√©posez vos PDFs ici ou cliquez
          </div>
          <ul id="pdf-list" class="mt-2 space-y-2"></ul>
        </div>
        
        <hr class="border-[var(--border-light)] my-6" />
        
        <!-- URLs -->
        <div class="mb-6">
          <label class="font-semibold block mb-1">URLs</label>
          <div class="flex gap-2 mt-2">
            <input id="url-input" type="url" placeholder="https://exemple.org/article" class="flex-1 border border-[var(--border-medium)] rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" />
            <button id="add-url" class="btn-primary" type="button">Ajouter</button>
          </div>
          <ul id="url-list" class="mt-2 space-y-2"></ul>
        </div>
        
        <hr class="border-[var(--border-light)] my-6" />
        
        <!-- Notes -->
        <div class="mb-6">
          <label for="notes" class="font-semibold block mb-1">Notes</label>
          <textarea id="notes" placeholder="Collez ici un extrait, un r√©sum√©, des points cl√©s‚Ä¶" rows="5" class="w-full border border-[var(--border-medium)] rounded-lg px-3 py-2 bg-white resize-y focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"></textarea>
          <div id="notes-count" class="text-xs text-[var(--text-tertiary)] mt-1">0 caract√®res</div>
        </div>
        
        <hr class="border-[var(--border-light)] my-6" />
        
        <!-- Recherche -->
        <div class="bg-[var(--surface-raised)] border border-[var(--border-light)] rounded-xl p-4">
          <div class="font-semibold text-[var(--text-primary)] mb-1">Recherche Google</div>
          <p class="text-xs text-[var(--text-tertiary)] mb-3">Recherchez des sources compl√©mentaires sur le web</p>
          <div class="flex gap-2">
            <input id="gq" type="text" placeholder="Ex: tram lyon T10 phase 2" class="flex-1 border border-[var(--border-medium)] rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" />
            <button id="gsearch" class="btn-primary" type="button">Rechercher</button>
          </div>
          <ul id="gresults" class="mt-2 space-y-2"></ul>
        </div>
        
        <!-- Navigation -->
        <div class="flex justify-end mt-6 pt-6 border-t border-[var(--border-light)]">
          <button id="btn-next-step" class="btn-primary" type="button" disabled>G√©n√©rer les contenus ‚Üí</button>
        </div>
      </div>
    </div>
    
    <!-- √âtape 2 : R√©sultats -->
    <div id="step2-content" class="hidden transition-opacity duration-300">
      
      <!-- Progress -->
      <div id="gen-progress-container" class="hidden mb-6">
        <div class="bg-[var(--card)] border border-[var(--border-light)] rounded-xl p-6 shadow-sm">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-[var(--primary)] text-[var(--text-on-primary)] rounded-lg flex items-center justify-center">
              <div class="w-5 h-5 border-2 border-[var(--text-on-primary)] border-t-transparent rounded-full animate-spin"></div>
            </div>
            <div class="flex-1">
              <h3 class="font-bold">G√©n√©ration en cours...</h3>
              <p class="text-sm text-[var(--text-tertiary)]" id="gen-status-text">Extraction des sources</p>
            </div>
            <span class="text-2xl font-bold text-[var(--primary)]" id="gen-percentage">0%</span>
          </div>
          <div class="relative h-1 bg-[var(--border-light)] rounded-full overflow-hidden">
            <div id="gen-progress-bar" class="absolute h-full bg-[var(--primary)] transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
      </div>
      
      <!-- R√©sultats -->
      <div id="results-container" class="hidden space-y-4">
        
        <!-- M√©ta -->
        <div class="bg-[var(--surface-raised)] border border-[var(--border-light)] rounded-xl p-6 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <span class="px-3 py-1 bg-[var(--primary-alpha-12)] text-[var(--primary)] rounded-full text-xs font-semibold uppercase tracking-wide">üéØ SEO</span>
              <h3 class="font-bold">M√©ta description</h3>
            </div>
            <button id="copy-meta" class="btn-secondary btn-small">Copier</button>
          </div>
          <textarea id="prep-meta" rows="3" placeholder="G√©n√©ration en cours..." class="w-full border-0 bg-transparent resize-none focus:outline-none font-medium"></textarea>
          <div class="text-xs text-[var(--text-tertiary)] mt-2"><span id="meta-chars">0</span> caract√®res</div>
        </div>
        
        <!-- Description -->
        <div class="bg-[var(--surface-raised)] border border-[var(--border-light)] rounded-xl p-6 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <span class="px-3 py-1 bg-[var(--info-lighter)] text-[var(--info)] rounded-full text-xs font-semibold uppercase tracking-wide">üìù Description</span>
              <h3 class="font-bold">Description courte</h3>
            </div>
            <button id="copy-desc" class="btn-secondary btn-small">Copier</button>
          </div>
          <textarea id="prep-description" rows="6" placeholder="G√©n√©ration en cours..." class="w-full border-0 bg-transparent resize-none focus:outline-none"></textarea>
          <div class="text-xs text-[var(--text-tertiary)] mt-2"><span id="desc-chars">0</span> caract√®res</div>
        </div>
        
        <!-- Article -->
        <div class="bg-[var(--surface-raised)] border border-[var(--border-light)] rounded-xl p-6 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <span class="px-3 py-1 bg-[var(--danger-alpha-12)] text-[var(--danger)] rounded-full text-xs font-semibold uppercase tracking-wide">üìö Article</span>
              <h3 class="font-bold">Article complet (Markdown)</h3>
            </div>
            <div class="flex gap-2">
              <button id="toggle-preview" class="btn-secondary btn-small">Aper√ßu</button>
              <button id="copy-md" class="btn-secondary btn-small">Copier</button>
            </div>
          </div>
          <textarea id="prep-markdown" rows="15" placeholder="G√©n√©ration en cours..." class="w-full border-0 bg-transparent resize-none focus:outline-none font-mono text-sm"></textarea>
          <div id="md-preview" class="hidden mt-4 pt-4 border-t border-[var(--border-light)]"></div>
          <div class="text-xs text-[var(--text-tertiary)] mt-2"><span id="article-chars">0</span> caract√®res</div>
        </div>
        
        <!-- Success -->
        <div class="bg-[var(--success-lighter)] border border-[var(--success-light)] rounded-xl p-4 flex items-center gap-3">
          <div class="w-8 h-8 bg-[var(--success)] text-[var(--text-on-primary)] rounded-full flex items-center justify-center shrink-0">‚úì</div>
          <div>
            <h4 class="font-bold text-[var(--success)]">Contenus g√©n√©r√©s avec succ√®s !</h4>
            <p class="text-sm text-[var(--text-secondary)]">Vous pouvez copier les textes et les utiliser dans vos projets</p>
          </div>
        </div>
      </div>
      
      <!-- Navigation -->
      <div class="flex justify-between mt-6 pt-6 border-t border-[var(--border-light)]">
        <button id="btn-prev-step" class="btn-secondary">‚Üê Retour aux sources</button>
        <button id="btn-new-generation" class="btn-primary">üîÑ Nouvelle g√©n√©ration</button>
      </div>
    </div>
    
  </div>
  
  <!-- Modale de recherche -->
  <div id="gmodal" class="gp-modal-overlay" role="dialog" aria-modal="true" style="display:none">
    <div class="gp-modal">
      <div class="gp-modal-header">
        <div class="gp-modal-title">R√©sultats de la recherche</div>
        <div class="flex gap-2">
          <button id="gmodal-add" class="btn-primary btn-small">Ajouter √† la liste</button>
        </div>
        <button class="btn-secondary gp-modal-close" type="button">&times;</button>
      </div>
      <div class="gp-modal-body">
        <div id="gmodal-error" class="hidden bg-[var(--danger-lighter)] text-[var(--danger)] border border-[var(--danger-light)] px-3 py-2 rounded-lg text-sm mb-3"></div>
        <div class="relative h-2.5 bg-[var(--border-light)] rounded-full mb-2">
          <div id="gprogress-bar" class="absolute left-0 top-0 h-full bg-[var(--primary)] rounded-full transition-all" style="width: 0%"></div>
        </div>
        <div id="gprogress-label" class="text-xs text-[var(--text-tertiary)] mb-3">0 utiles (max 10)</div>
        <ul id="gresults-modal" class="space-y-2"></ul>
      </div>
    </div>
  </div>
  
  <script>
    // SCRIPT DE BRANDING - EX√âCUT√â APR√àS CHARGEMENT DOM
    console.log('[Assistant IA] üèÅ SCRIPT CHARG√â - DOM READY');
    
    // SIMPLIFICATION : Charger le branding directement sans d√©pendances externes
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[Assistant IA] üì¶ D√âMARRAGE CHARGEMENT BRANDING - DOMContentLoaded');
      
      try {
        // 1. R√©cup√©rer la ville active depuis localStorage ou URL
        console.log('[Assistant IA] üîç DIAGNOSTIC VILLE:');
        console.log('  - URL compl√®te:', window.location.href);
        console.log('  - pathname complet:', location.pathname);
        console.log('  - pathname split:', location.pathname.split('/'));
        
        const pathSegments = location.pathname.split('/').filter(s => s.length > 0);
        console.log('  - pathSegments (filtr√©s):', pathSegments);
        
        const pathCity = pathSegments[0]; // Premier segment
        console.log('  - pathCity extrait:', pathCity);
        console.log('  - pathCity !== "assistant-ia" ?', pathCity !== 'assistant-ia');
        console.log('  - pathCity !== "" ?', pathCity !== '');
        
        const saved = localStorage.getItem('activeCity');
        console.log('  - localStorage activeCity:', saved);
        console.log('  - saved && saved !== "default" ?', saved && saved !== 'default');
        
        const getActiveCity = () => {
          // Depuis le pathname (prioritaire)
          if (pathCity && pathCity !== 'assistant-ia' && pathCity !== '') {
            console.log('  ‚Üí VILLE depuis pathname:', pathCity.toLowerCase());
            return pathCity.toLowerCase();
          }
          // Depuis localStorage
          if (saved && saved !== 'default' && saved !== '') {
            console.log('  ‚Üí VILLE depuis localStorage:', saved);
            return saved;
          }
          console.log('  ‚Üí AUCUNE VILLE TROUV√âE');
          return null;
        };
        
        const activeCity = getActiveCity();
        console.log(`[Assistant IA] üìç VILLE ACTIVE FINALE: "${activeCity}"`);
        console.log(`[Assistant IA] üìç TYPE: ${typeof activeCity}`);
        console.log(`[Assistant IA] üìç CONDITION if(activeCity): ${!!activeCity}`);
        
        // 2. Si ville trouv√©e, charger le branding directement
        if (activeCity) {
          console.log(`[Assistant IA] üé® CHARGEMENT BRANDING POUR: "${activeCity}"`);
          
          const supabaseUrl = `https://wqqsuybmyqemhojsamgq.supabase.co/rest/v1/city_branding?ville=eq.${activeCity}&select=*`;
          console.log('[Assistant IA] üîó URL Supabase:', supabaseUrl);
          
          const response = await fetch(supabaseUrl, {
            method: 'GET',
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxcXN1eWJteXFlbWhvanNhbWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAxNDYzMDQsImV4cCI6MjA0NTcyMjMwNH0.OpsuMB9GfVip2BjlrERFA_CpCOLsjNGn-ifhqwiqLl0',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxcXN1eWJteXFlbWhvanNhbWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAxNDYzMDQsImV4cCI6MjA0NTcyMjMwNH0.OpsuMB9GfVip2BjlrERFA_CpCOLsjNGn-ifhqwiqLl0',
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          console.log('[Assistant IA] üì° Response status:', response.status);
          console.log('[Assistant IA] üì° Response ok:', response.ok);
          
          if (!response.ok) {
            console.error('[Assistant IA] ‚ùå Erreur HTTP:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('[Assistant IA] ‚ùå Response body:', errorText);
            return;
          }
          
          const data = await response.json();
          console.log('[Assistant IA] üé® Branding re√ßu (brut):', data);
          console.log('[Assistant IA] üé® Branding re√ßu (type):', typeof data);
          console.log('[Assistant IA] üé® Branding re√ßu (length):', data?.length);
          
          if (data && data[0]) {
            const branding = data[0];
            console.log('[Assistant IA] üé® Branding trouv√©, application...');
            
            // Appliquer le logo
            if (branding.logo_url) {
              const logoImg = document.getElementById('logo-img');
              if (logoImg) {
                logoImg.src = branding.logo_url;
                logoImg.alt = `Logo ${activeCity}`;
                console.log(`[Assistant IA] ‚úÖ Logo appliqu√©: ${branding.logo_url}`);
              }
            }
            
            // Appliquer la couleur principale et toutes ses d√©riv√©es
            if (branding.primary_color && branding.primary_color.match(/^#[0-9A-Fa-f]{6}$/)) {
              const primaryColor = branding.primary_color;
              
              // Appliquer la couleur de base
              document.documentElement.style.setProperty('--color-primary', primaryColor);
              document.documentElement.style.setProperty('--primary', primaryColor);
              
              // Appliquer toutes les variations bas√©es sur cette couleur
              document.documentElement.style.setProperty('--primary-hover', `color-mix(in srgb, ${primaryColor} 85%, black)`);
              document.documentElement.style.setProperty('--primary-active', `color-mix(in srgb, ${primaryColor} 70%, black)`);
              document.documentElement.style.setProperty('--primary-light', `color-mix(in srgb, ${primaryColor} 25%, transparent)`);
              document.documentElement.style.setProperty('--primary-lighter', `color-mix(in srgb, ${primaryColor} 12%, transparent)`);
              
              console.log(`[Assistant IA] ‚úÖ Couleur primaire appliqu√©e: ${primaryColor}`);
              console.log(`[Assistant IA] ‚úÖ Variations primary g√©n√©r√©es automatiquement`);
              
              // V√©rifier
              setTimeout(() => {
                const computedColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary');
                console.log(`[Assistant IA] üé® V√©rification: --color-primary = "${computedColor}"`);
              }, 100);
            } else {
              console.warn('[Assistant IA] ‚ö†Ô∏è Couleur invalide:', branding.primary_color);
            }
          } else {
            console.warn('[Assistant IA] ‚ö†Ô∏è Aucun branding trouv√© pour:', activeCity);
          }
        } else {
          console.log('[Assistant IA] ‚ÑπÔ∏è Mode global, pas de branding sp√©cifique');
        }
        
      } catch (error) {
        console.error('[Assistant IA] ‚ùå Erreur chargement branding:', error);
      }
    });
  </script>
  
  <script src="./assistant-ia-clean.js"></script>
</body>
</html>
