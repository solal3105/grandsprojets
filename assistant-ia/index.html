<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistant IA ‚Äî Grands Projets</title>
  <meta name="description" content="Assistant IA pour pr√©parer les contenus: Markdown, m√©ta et description √† partir de PDFs, URLs et notes." />
  <link rel="icon" href="/img/logomin.png" />
  <link rel="stylesheet" href="/src/styles/assistant-ai.css">
  <!-- Appliquer le th√®me sombre t√¥t si d√©fini dans localStorage ('theme'='dark') -->
  <script>
    (function(){
      try {
        var t = localStorage.getItem('theme');
        if (t === 'dark') { document.documentElement.classList.add('dark'); }
        else { document.documentElement.classList.remove('dark'); }
        // R√©agir si le th√®me change dans un autre onglet
        window.addEventListener('storage', function(ev){
          if (ev.key === 'theme') {
            if (ev.newValue === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
          }
        });
      } catch (_) { /* no-op */ }
    })();
  </script>
  <!-- PDF.js pour extraire du texte des PDFs c√¥t√© client -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <!-- Markdown renderer + sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <img src="/img/logo.svg" alt="Grands Projets" style="height:56px; width:auto;" />
    </div>

  <!-- Modale de progression extraction -->
  <div id="pmodal" class="modal-overlay" hidden aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pmodal-title" tabindex="-1">
      <div class="modal-header">
        <h2 id="pmodal-title" style="margin:0; font-size:18px; color:#111827;">Pr√©paration des contenus</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="pm-status"><span class="dot" id="pmodal-dot"></span><span id="pmodal-status-text">En attente‚Ä¶</span></span>
          <button id="pmodal-close" class="btn secondary" type="button" aria-label="Fermer la modale" disabled>Fermer</button>
        </div>
      </div>
      <div class="modal-body">
        <ul id="pmodal-list" class="clean"></ul>
        <div style="display:flex; justify-content:flex-end; margin-top:10px;">
          <button id="pmodal-generate" class="btn" type="button" hidden>G√©n√©rer le contenu</button>
        </div>
      </div>
    </div>
  </div>

    <section class="hero" aria-label="Assistant pour pr√©parer vos contenus">
      <h1>Pr√©parez automatiquement vos contenus</h1>
      <p>D√©posez des PDFs, ajoutez des URLs et vos notes. Lancez la lecture des documents, puis g√©n√©rez une m√©ta description SEO et une description en Markdown pr√™tes √† publier.</p>
    </section>

    <div id="grid" class="grid onecol" role="region" aria-label="Zone de travail">
      <!-- Colonne gauche: sources -->
      <div class="card" aria-labelledby="sources-title">
        <h2 id="sources-title">Sources</h2>

        <!-- PDFs -->
        <div class="block" aria-labelledby="pdf-title">
          <div>
            <div id="pdf-title" style="font-weight:600;">PDFs</div>
            <div class="small">Glissez-d√©posez ou cliquez pour s√©lectionner des fichiers .pdf</div>
          </div>
          <input id="pdf-input" type="file" accept="application/pdf" multiple hidden />
          <div id="pdf-drop" class="dropzone" role="button" tabindex="0" aria-label="D√©poser ou choisir des fichiers PDF">
            üìÑ D√©posez vos PDFs ici ou cliquez pour choisir
          </div>
          <ul id="pdf-list" class="clean" aria-live="polite"></ul>
        </div>

        <hr style="border:none; border-top:1px solid #eef2f7; margin:14px 0;" />

        <!-- URLs -->
        <div class="block" aria-labelledby="url-title">
          <div id="url-title" style="font-weight:600;">URLs</div>
          <div class="row" style="margin-top:6px;">
            <input id="url-input" class="input" type="url" placeholder="https://exemple.org/article" aria-label="Ajouter une URL" />
            <button id="add-url" class="btn" type="button">Ajouter</button>
          </div>
          <ul id="url-list" class="clean" aria-live="polite"></ul>
        </div>

        <hr style="border:none; border-top:1px solid #eef2f7; margin:14px 0;" />

        <!-- Notes texte -->
        <div class="block" aria-labelledby="notes-title">
          <div id="notes-title" style="font-weight:600;">Notes</div>
          <textarea id="notes" placeholder="Collez ici un extrait, un r√©sum√©, des points cl√©s‚Ä¶" aria-label="Notes libres"></textarea>
          <div class="small" id="notes-count">0 caract√®res</div>
        </div>

        <hr style="border:none; border-top:1px solid #eef2f7; margin:14px 0;" />

        <!-- Recherche Google par mots-cl√©s (UI uniquement) -->
        <div class="block gsearch-card" aria-labelledby="gsearch-title">
          <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
            <div>
              <div id="gsearch-title" class="gsearch-title">Recherche Google (mots-cl√©s)</div>
              <div class="small">Prototype d‚Äôinterface ‚Äî la recherche sera branch√©e plus tard</div>
            </div>
          </div>
          <div class="row" style="margin-top:8px; gap:8px;">
            <input id="gq" class="input" type="text" placeholder="Ex: tram lyon T10 phase 2 dossier enqu√™te" aria-label="Mots-cl√©s" />
            <button id="gsearch" class="btn" type="button" aria-label="Lancer la recherche">Rechercher</button>
          </div>
          <ul id="gresults" class="clean" aria-live="polite" style="margin-top:8px;">
            <li class="small" aria-hidden="true" hidden>Les r√©sultats appara√Ætront ici‚Ä¶</li>
          </ul>
        </div>
      </div>

      <!-- Colonne droite: pr√©paration -->
      <aside id="prep-card" class="card" aria-labelledby="prep-title" hidden>
        <h2 id="prep-title">Pr√©paration Markdown / M√©ta / Description</h2>
        <p class="hint">Le contenu g√©n√©r√© appara√Ætra ici apr√®s l'extraction et la g√©n√©ration.</p>
        <div id="prep-output" style="display:grid; gap:10px;">
          <div>
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <label class="small" for="prep-meta">M√©ta description (SEO)</label>
              <button id="copy-meta" type="button" class="btn" style="padding:6px 10px;" hidden>Copier</button>
            </div>
            <textarea id="prep-meta" rows="3" style="width:100%; resize:vertical; border:1px solid #e5e7eb; border-radius:8px; padding:8px;" placeholder="Sera remplie apr√®s g√©n√©ration"></textarea>
          </div>
          <div>
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <label class="small" for="prep-description">Description (texte)</label>
              <button id="copy-desc" type="button" class="btn" style="padding:6px 10px;" hidden>Copier</button>
            </div>
            <textarea id="prep-description" rows="5" style="width:100%; resize:vertical; border:1px solid #e5e7eb; border-radius:8px; padding:8px;" placeholder="Description courte g√©n√©r√©e ici (‚â§ 450 caract√®res)"></textarea>
          </div>
          <div>
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <label class="small" for="prep-markdown">Article (Markdown)</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <button id="toggle-preview" type="button" class="btn secondary" style="padding:6px 10px;" hidden>Aper√ßu</button>
                <button id="copy-md" type="button" class="btn" style="padding:6px 10px;" hidden>Copier</button>
              </div>
            </div>
            <textarea id="prep-markdown" rows="12" style="width:100%; resize:vertical; border:1px solid #e5e7eb; border-radius:8px; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;" placeholder="Markdown g√©n√©r√© ici"></textarea>
            <div id="md-preview" class="md-preview" hidden aria-live="polite"></div>
            <!-- Message post-g√©n√©ration -->
            <div id="post-gen-hint" class="pill" hidden style="margin-top:10px;">Les trois textes sont pr√™ts. Utilisez les boutons ‚ÄúCopier‚Äù pour les coller dans la fiche projet.</div>
          </div>

        </div>
      </aside>
    </div>

    <div class="row" style="margin-top:16px; justify-content:flex-end; gap:8px;">
      <button id="continue" class="btn" type="button" disabled>Lancer la lecture des documents</button>
    </div>
  </div>
  
  <!-- Modale de r√©sultats de recherche -->
  <div id="gmodal" class="modal-overlay" hidden aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="gmodal-title" tabindex="-1">
      <div class="modal-header">
        <h2 id="gmodal-title" style="margin:0; font-size:18px; color:#111827;">R√©sultats de la recherche</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="gmodal-add" class="btn" type="button" aria-label="Ajouter les √©l√©ments s√©lectionn√©s √† la liste">Ajouter √† la liste</button>
          <button id="gmodal-close" class="btn secondary" type="button" aria-label="Fermer la modale">Fermer</button>
        </div>
      </div>
      <div class="modal-body" id="gmodal-body">
        <div id="gmodal-error" class="alert-error" hidden></div>
        <div class="progress" aria-label="Progression des r√©sultats utiles (cap √† 10)">
          <div id="gprogress-bar" class="progress-bar"></div>
        </div>
        <div id="gprogress-label" class="progress-label">0 utiles (max 10)</div>
        <ul id="gresults-modal" class="clean"></ul>
      </div>
    </div>
  </div>
  <script type="module" src="/src/pages/assistant-ia.js"></script>
</body>
</html>
